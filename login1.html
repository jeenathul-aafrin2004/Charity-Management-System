<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduDonate Login</title>
  <link rel="stylesheet" href="login.css" />
  <style>
    .nav-links a {
      color: black !important;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.3s;
    }
    .nav-links a:hover,
    .nav-links a.active {
      color: #26012f !important;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCw_7hQeQM3tXsRb3z7SKlW1ARKJL5buGQ",
      authDomain: "edudonate-e5bc4.firebaseapp.com",
      projectId: "edudonate-e5bc4",
      storageBucket: "edudonate-e5bc4.appspot.com",
      messagingSenderId: "710950970152",
      appId: "1:710950970152:web:583eec98550dec8728661d",
      measurementId: "G-QNZ692FRRM"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>

  <header class="navbar">
    <div class="logo">EduDonate</div>
    <nav>
      <ul class="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="aboutus.html">About Us</a></li>
        <li><a href="feature.html">Features</a></li>
        <li><a href="#" class="active">Login</a></li>
        <li><a href="register.html">Register</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <section class="left-panel">
      <h1>Empowering Futures Through Transparent Donations</h1>
      <p>We connect compassionate donors with deserving students through secure and impactful donations.</p>
    </section>

    <section class="login-box animate-fade-in">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Login</button>
        <p id="error-message" style="color: red;"></p>
        <p id="redirecting-message" style="color: green;"></p>
        <p class="signup-link">Don't have an account? <a href="register.html">Register here</a></p>
      </form>
    </section>
  </main>

  <script>
    document.getElementById("loginForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const errorMsg = document.getElementById("error-message");
      const redirectMsg = document.getElementById("redirecting-message");

      errorMsg.innerText = "";
      redirectMsg.innerText = "⏳ Logging in...";

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;

          db.collection("users").doc(user.uid).get().then(doc => {
            if (doc.exists) {
              const userType = doc.data().userType;

              if (userType === "donor") {
                // Check if donor has profile in "profiles"
                db.collection("profiles").doc(user.uid).get().then(profileDoc => {
                  if (profileDoc.exists) {
                    redirectMsg.innerText = "✅ Welcome back, Donor! Redirecting...";
                    setTimeout(() => {
                      window.location.href = `profile.html?uid=${user.uid}`;
                    }, 1000);
                  } else {
                    redirectMsg.innerText = "✅ Welcome Donor! Redirecting to profile form...";
                    setTimeout(() => {
                      window.location.href = "donorProfileForm.html";
                    }, 1000);
                  }
                });

              } else if (userType === "student") {
                // Check if student has profile in "student_profiles"
                db.collection("student_profiles").doc(user.uid).get().then(profileDoc => {
                  if (profileDoc.exists) {
                    redirectMsg.innerText = "✅ Welcome back, Student! Redirecting...";
                    setTimeout(() => {
                      window.location.href = `studentprofile.html?uid=${user.uid}`;
                    }, 1000);
                  } else {
                    redirectMsg.innerText = "✅ Welcome Student! Redirecting to profile form...";
                    setTimeout(() => {
                      window.location.href = "studentprofileform.html";
                    }, 1000);
                  }
                });

              } else {
                auth.signOut();
                errorMsg.innerText = "❌ Access restricted. Only donors and students can log in.";
                redirectMsg.innerText = "";
              }

            } else {
              auth.signOut();
              errorMsg.innerText = "❌ User not found. Please register first.";
              redirectMsg.innerText = "";
            }
          });
        })
        .catch((error) => {
          errorMsg.innerText = "❌ " + error.message;
          redirectMsg.innerText = "";
        });
    });
  </script>

</body>
</html>
